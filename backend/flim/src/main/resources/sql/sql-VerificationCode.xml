<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.flim.mapper.AuthMapper">
	
	
	<insert id="insertVerificationCode">
	 INSERT INTO verification (email,code, purpose,expires_at,used)
	 VALUES (
	          #{email}, 
	          #{code}, 
	          #{purpose}, 
	          #{expiresAt}, 
	           FALSE
	          )
	</insert>
		
	 <select id="findVerificationCode" resultType="string">
        SELECT code
        FROM  verification
        WHERE email   = #{email}
          AND purpose = #{purpose}
          AND used    = FALSE
          AND expires_at > NOW()
        ORDER BY created_at DESC
        LIMIT 1
    </select>
			
    <update id="markUsedVerificationCode">
    UPDATE verification
    SET used      = TRUE
    WHERE email   = #{email}
      AND purpose = #{purpose}
      AND used    = FALSE
    ORDER BY created_at DESC
    LIMIT 1
    </update>
	


	
</mapper>